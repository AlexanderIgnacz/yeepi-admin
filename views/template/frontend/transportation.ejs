<%layout('../../layout')%>
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Transportations</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    DataTables Advanced Transportations
                    <button type="button" class="btn btn-primary btn-xs pull-right" id="createNewUserModalBtn">Create New Transportation</button>
                </div>
                <div class="panel-body">
                    <div class="dataTable_wrapper" id="admintablecontainer" />
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>

        <div class="col-lg-6">
            <!-- Modal -->
            <div class="modal fade" id="userEditModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Modify Transportations</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Transportation Image</label>
                                            <img width="150" height="150" id="transportationimg_modify" class="transportationimg">
                                            <input type="file" id="myFile">
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Vehicle Name</label>
                                            <input class="form-control" id="modifyUserName">
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Status</label>
                                            <select class="form-control" id="status_modify">
                                                <option>Enabled</option>
                                                <option>Disabled</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="modifyUserSave">Save changes</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>

        <div class="col-lg-6">
            <!-- Modal -->
            <div class="modal fade" id="userCreateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Create New Transportation</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Transportation Image</label>
                                            <img src="/images/tiger.png" width="150" height="150" id="transportationimg" class="transportationimg">
                                            <input type="file" id="myFile">
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Vehicle Name</label>
                                            <input class="form-control" id="createModalUserName">
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Status</label>
                                            <select class="form-control" id="status">
                                                <option>Enabled</option>
                                                <option>Disabled</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="createModalUserCreateBtn">Create</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>

        <div class="col-lg-6">
            <!-- View Modal -->
            <div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">View User</h4>
                        </div>
                        <div class="modal-body">

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="viewModalCloseBtn">Create</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>

    </div>
</div>

<script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
<script>
  var current_userid = "";
  $(document).ready(function() {
    getList();
    $("#modifyUserSave").click(function() {
      var update_user = $('#modifyUserName').val();
      var update_pass = $('#modifyUserPass').val();
      var update_confpass = $('#modifyUserConfirmPass').val();
      var update_admintype = $('#modifyUserType').val();
      var update_status = $('#modifyUserStatus').val();
      if (update_user == "") {
        alert("You have to input update username");
      } else {
        if (update_pass == "") {
          alert("You have to input update password");
        } else {
          if (update_pass == update_confpass) {
            $.post("/user/update"
              ,{current_userid: current_userid, update_username: update_user, update_pass: update_pass, update_admintype: update_admintype, status: update_status}
              ,function(result){
                $('#userEditModal').modal('hide');
                getList();
              })


          } else {
            alert("Confirm password mismatch")
          }
        }
      }
    });

    $("#createModalUserCreateBtn").click(function() {
      var createModalVehicleName = $('#createModalUserName').val();
      var createModalStatus = $('#status').val() === "Enabled" ? 1 : 0;
      var createModalImage = $('#transportationimg').attr('src');

      if (createModalVehicleName === "") {
        alert("You have to input vehicle name");
      } else {

        $.ajax({
          url: '/trans/create',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ vehiclename: createModalVehicleName, status: createModalStatus, preview_img: createModalImage }),
          success: function(response){
            $('#userCreateModal').modal('hide');
            getList();
          }})

      }
    });

    $("#createNewUserModalBtn").click(function() {
      $('#createModalUserEmail').val("");
      $('#createModalUserName').val("");
      $('#createModalUserPass').val("");
      $('#createModalUserConfPass').val("");
      $('#createModalUserType').val("Admin");
      $('#userCreateModal').modal('show');
    });

    $("#transportationimg").click(function() {
        $("#myFile").trigger('click')
    });

    $("#myFile").change(function() {
        readUrl(this);
    });

  });

  function readUrl(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();

      reader.onload = function(e) {
        $('#transportationimg').attr('src', e.target.result);
      }

      reader.readAsDataURL(input.files[0]);
    }
  }

  function getList() {
    $.get("/trans/list", {}, function(result) {
      var tb = $('#admintablecontainer');
      var div_data = "<table class=\"table table-striped table-bordered table-hover\" id=\"dataTables-example\"><thead><tr><th>Vehicle Name</th><th>Status</th><th>Action</th></tr></thead><tbody>";
      $.each(result,function(index, data){

        var vehiclename = data.vehiclename;
        var status = data.status === 0 ? "Disabled" : "Enabled";
        var preview_img = data.preview_img;
        var id = data._id;

        div_data+="<tr class='gradeA'><td>"+vehiclename+"</td><td>"+status+"</td><td><button type='button' class='btn btn-danger btn-circle' onclick='removeUser(\""+id+"\",\""+vehiclename+"\")'><i class='fa fa-times'></i></button>&nbsp<button type='button' class='btn btn-warning btn-circle' onclick='editUser(\""+id+"\",\""+vehiclename+"\",\""+status+"\",\""+preview_img+"\")'><i class='fa fa-pencil-square-o'></i></button></td></tr>";
      })
      div_data += "</tbody></table>";
      tb.html(div_data);
      $('table').dataTable({
        responsive: true
      });
    });
  }

  function removeUser(id,username) {
    if (confirm('Are you sure you want to remove this transportation?')) {
      $.post("/trans/remove", { id: id }, function(result) {
        getList()
      });
    }
  }

  function viewUser(id,username) {
    //$('#viewModal').modal('show');
  }

  function editUser(id, username, status, preview_img) {
//    $.get("/user/role", {}, function(result) {
//      if (result.result == "error") {
//        alert("Error");
//      } else if (result.result == "Admin") {
//        current_userid = id;
//        $('#modifyUserName').val(username);
//        $('#modifyUserPass').val("");
//        $('#modifyUserConfirmPass').val("");
//        $('#userEditModal').modal('show');
//      } else {
//        $.get("/user/checkpermission", {id: id}, function(result) {
//          if (result.result == "error") {
//            alert("error");
//          } else if (result.result == "inactive") {
//            alert("you don't have permission to edit this user")
//          } else {
            current_userid = id;
            $('#modifyUserName').val(username);
            $('#status_modify').val(status);
            $('#transportationimg_modify').attr('src', preview_img)

            $('#userEditModal').modal('show');
//          }
//        })
//      }
//    });
  }

</script>
